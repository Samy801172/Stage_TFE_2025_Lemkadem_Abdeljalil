import{a as I}from"./chunk-FFOOKV3M.js";import{a as h}from"./chunk-PRKGXYQV.js";import{D as u,G as b,J as s,a as g,b as p,f,i as S,ib as w,l,sb as U,v as d}from"./chunk-OJEA5YKO.js";function v(o){let m=new Date;return o.created_at&&!isNaN(new Date(o.created_at).getTime())&&(m=new Date(o.created_at)),{id:o.id,username:o.nom||o.prenom||"Non sp\xE9cifi\xE9",email:o.email||"Non sp\xE9cifi\xE9",firstName:o.prenom||"Non sp\xE9cifi\xE9",lastName:o.nom||"",company:o.entreprise||"Non sp\xE9cifi\xE9",position:o.secteur||"Non sp\xE9cifi\xE9",phone:o.telephone||o.phone||"",address:"",city:"",country:"",profileImage:o.photo||"",photo:o.photo||"",bio:o.bio||"",linkedinUrl:o.linkedin||"",website:"",isActive:o.isActive,joinDate:m}}var n=function(o){return o.ADMIN="ADMIN",o.ORGANIZER="ORGANIZER",o.MEMBER="MEMBER",o}(n||{});var O=(()=>{class o{constructor(e,t,r){this.http=e,this.router=t,this.notificationService=r,this.apiUrl=`${h.apiUrl}/security`,this.currentUserSubject=new S(null),this.currentUser$=this.currentUserSubject.asObservable();let a=localStorage.getItem("currentUser");a&&this.currentUserSubject.next(JSON.parse(a))}login(e){console.log("Login attempt with credentials:",p(g({},e),{password:"***"}));let t=e.socialLogin?"google/signin":"signin";return this.http.post(`${this.apiUrl}/${t}`,e).pipe(u(r=>{if(console.log("Auth Response:",r),r?.data){localStorage.setItem("token",r.data.token),localStorage.setItem("refreshToken",r.data.refreshToken);let a=this.parseJwt(r.data.token),i=a.role||n.MEMBER,c={id:a.userId,username:a.username,mail:a.email,role:i,isAdmin:i===n.ADMIN,credential_id:r.data.token_id,active:!0,created:new Date,updated:new Date};console.log("Created user object:",c),localStorage.setItem("currentUser",JSON.stringify(c)),this.currentUserSubject.next(c),this.router.navigate([i===n.ADMIN?"/admin/dashboard":"/dashboard"]).catch(N=>{console.error("Navigation error:",N),window.location.href=i===n.ADMIN?"/admin/dashboard":"/dashboard"})}}),d(r=>(console.log("CATCH ERROR DANS AUTHSERVICE",r),l(()=>r))))}parseJwt(e){try{let r=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/");return JSON.parse(window.atob(r))}catch(t){return console.error("Error parsing JWT:",t),{}}}redirectBasedOnRole(){return f(this,null,function*(){try{let e=this.currentUserSubject.value;if(!e){console.error("No current user found"),window.location.replace("/auth/login");return}if(console.log("Redirecting user with role:",e.role),e.role===n.ADMIN){console.log("Redirecting admin to dashboard");try{(yield this.router.navigate(["/admin/dashboard"]))||(console.log("Angular navigation failed, using location.replace"),window.location.replace("/admin/dashboard"))}catch(t){console.error("Navigation error:",t),window.location.replace("/admin/dashboard")}}else console.log("Redirecting member to dashboard"),window.location.replace("/dashboard")}catch(e){console.error("Redirect error:",e),window.location.replace("/dashboard")}})}saveSession(e){try{if(localStorage.clear(),e?.data?.token){localStorage.setItem("token",e.data.token),localStorage.setItem("refreshToken",e.data.refreshToken),localStorage.setItem("lastLogin",new Date().toISOString());let t=this.parseJwt(e.data.token);if(t){let r={id:t.userId,username:t.username,mail:t.email,role:t.role||n.MEMBER,isAdmin:t.role===n.ADMIN,credential_id:e.data.token_id,active:!0,created:new Date,updated:new Date};localStorage.setItem("currentUser",JSON.stringify(r)),this.currentUserSubject.next(r)}}}catch(t){console.error("Error saving session:",t),localStorage.clear(),this.currentUserSubject.next(null)}}restoreSession(){try{let e=localStorage.getItem("token"),t=localStorage.getItem("currentUser");if(e&&t){let r=this.parseJwt(e);r&&r.exp*1e3>Date.now()?this.currentUserSubject.next(JSON.parse(t)):(console.log("Token expired during session restore"),this.logout())}}catch(e){console.error("Error restoring session:",e),this.logout()}}isAdmin(){let e=this.getCurrentUserValue();return console.log("isAdmin check - Current user:",e),e?.role===n.ADMIN}logout(){localStorage.clear(),this.currentUserSubject.next(null),this.router.navigate(["/auth/login"])}isLoggedIn(){return!!localStorage.getItem("token")}register(e){let t={username:e.username,password:e.password,mail:e.mail,nom:e.lastName,prenom:e.firstName,entreprise:e.companyName},r=e.username.toLowerCase().includes("admin")?"admin-signup":"signup";return this.http.post(`${this.apiUrl}/${r}`,t).pipe(u(a=>{if(a?.data?.token&&(localStorage.setItem("token",a.data.token),localStorage.setItem("refreshToken",a.data.refreshToken),a.data.credential)){let i={id:a.data.credential.id,username:a.data.credential.username,isAdmin:a.data.credential.isAdmin,credential_id:a.data.token_id,mail:a.data.credential.mail,active:!0,created:new Date,updated:new Date,role:a.data.credential.isAdmin?n.ADMIN:n.MEMBER};localStorage.setItem("currentUser",JSON.stringify(i)),this.currentUserSubject.next(i)}}),d(a=>(console.error("Erreur d'inscription:",a),l(()=>a.error?.message||"Erreur lors de l'inscription"))))}getCurrentUser(){return this.http.get(`${this.apiUrl}/me`)}hasRequiredRoles(e){let t=this.currentUserSubject.value;if(!t||!t.role)return this.router.navigate(["/auth/login"]),!1;let r=t.role;if(!Object.values(n).includes(r))return console.warn(`R\xF4le invalide: ${r}`),this.router.navigate(["/dashboard"]),!1;let a=e.includes(r);return a||(this.router.navigate(["/dashboard"]),console.warn(`Acc\xE8s refus\xE9. R\xF4le requis: ${e.join(" ou ")}, R\xF4le actuel: ${r}`)),a}handleAuthError(e){e.status===403&&(console.error("Acc\xE8s non autoris\xE9"),this.router.navigate(["/dashboard"]))}getCurrentUserId(){return this.currentUserSubject.value?.id||""}getCurrentUserValue(){return this.currentUserSubject.value}hasRole(e){let t=this.getCurrentUserValue();if(!t)return!1;let r=t.role;return!r||!Object.values(n).includes(r)?!1:e.includes(r)}updateCurrentUser(e){this.currentUserSubject.next(e)}forgotPassword(e){return this.http.post(`${h.apiUrl}/security/forgot-password`,{email:e})}static{this.\u0275fac=function(t){return new(t||o)(s(w),s(U),s(I))}}static{this.\u0275prov=b({token:o,factory:o.\u0275fac,providedIn:"root"})}}return o})();export{v as a,n as b,O as c};
